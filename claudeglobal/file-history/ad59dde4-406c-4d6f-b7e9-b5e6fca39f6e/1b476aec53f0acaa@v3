using System;
using System.Collections.Generic;
using FractalDataWorks.Results;
using FractalDataWorks.Services.DataGateway.Abstractions.Models;

namespace FractalDataWorks.Services.DataGateway.Abstractions.Commands;

/// <summary>
/// Command for executing data queries against data gateways.
/// </summary>
public sealed class DataQueryCommand : IDataGatewayCommand
{
    /// <summary>
    /// Gets the unique identifier for this command instance.
    /// </summary>
    public Guid CommandId { get; init; } = Guid.NewGuid();

    /// <summary>
    /// Gets the correlation identifier for tracking related commands.
    /// </summary>
    public Guid? CorrelationId { get; init; }

    /// <summary>
    /// Gets the timestamp when the command was created.
    /// </summary>
    public DateTimeOffset Timestamp { get; init; } = DateTimeOffset.UtcNow;

    /// <summary>
    /// Gets the command name.
    /// </summary>
    public string CommandName => "DataQuery";

    /// <summary>
    /// Gets the connection name to execute the query against.
    /// </summary>
    public string? ConnectionName { get; init; }

    /// <summary>
    /// Gets the target container for the query.
    /// </summary>
    public DataPath? TargetContainer { get; init; }

    /// <summary>
    /// Gets the query parameters.
    /// </summary>
    public IReadOnlyDictionary<string, object?> Parameters { get; init; } = new Dictionary<string, object?>();

    /// <summary>
    /// Gets the metadata for the command.
    /// </summary>
    public IReadOnlyDictionary<string, object> Metadata { get; init; } = new Dictionary<string, object>();

    /// <summary>
    /// Gets the timeout for the query execution.
    /// </summary>
    public TimeSpan? Timeout { get; init; }

    /// <summary>
    /// Gets the query expression or SQL statement.
    /// </summary>
    public string? QueryExpression { get; init; }

    /// <summary>
    /// Gets the expected result type for the query.
    /// </summary>
    public Type? ResultType { get; init; }

    /// <summary>
    /// Validates the command.
    /// </summary>
    /// <returns>A result indicating whether the command is valid.</returns>
    public IGenericResult Validate()
    {
        if (string.IsNullOrWhiteSpace(QueryExpression))
        {
            return GenericResult.Failure("Query expression is required");
        }

        return GenericResult.Success();
    }
}