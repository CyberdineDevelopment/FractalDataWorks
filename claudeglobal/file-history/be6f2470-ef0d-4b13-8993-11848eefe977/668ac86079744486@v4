using System;
using System.Collections.Generic;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using FractalDataWorks.ServiceTypes.Attributes;
using FractalDataWorks.Services;
using FractalDataWorks.Services.Abstractions;
using FractalDataWorks.Services.DataGateway.Abstractions;
using FractalDataWorks.Services.DataGateway.Services;

namespace FractalDataWorks.Services.DataGateway;

/// <summary>
/// Service type definition for SQL Server data provider.
/// </summary>
[ServiceTypeOption(typeof(DataGatewayTypes), "SqlDataGateway")]
public sealed class SqlDataGatewayServiceType :
    DataGatewayTypeBase<IDataGateway, IServiceFactory<IDataGateway, IDataGatewayConfiguration>, IDataGatewayConfiguration>
{
    /// <summary>
    /// Initializes a new instance of the <see cref="SqlDataGatewayServiceType"/> class.
    /// </summary>
    public SqlDataGatewayServiceType()
        : base(
            id: 1,
            name: "SqlServer",
            sectionName: "DataGateway:SqlServer",
            displayName: "SQL Server Data Gateway",
            description: "Microsoft SQL Server data provider service",
            supportedDataStores: ["MsSql", "AzureSql", "SqlServer"],
            priority: 100,
            supportsTransactions: true,
            supportsBulkOperations: true,
            supportsStreaming: true,
            maxBatchSize: 10000,
            providerName: "System.Data.SqlClient",
            connectionString: "Server={server};Database={database};Integrated Security=true;",
            supportsSchemaDiscovery: true,
            supportedCommands: new List<string> { "Query", "Insert", "Update", "Delete", "BulkInsert", "BulkUpsert", "Exists", "Count", "Truncate" }.AsReadOnly(),
            maxConnectionPoolSize: 100)
    {
    }

    /// <inheritdoc/>
    public override void Configure(IConfiguration configuration)
    {
        // Configuration is handled by the base class
    }

    /// <inheritdoc/>
    public override void Register(IServiceCollection services)
    {
        // Register the data gateway service
        services.AddScoped<IDataGateway, DataGatewayService>();

        // Register the generic factory
        services.AddScoped<IServiceFactory<IDataGateway, IDataGatewayConfiguration>, GenericServiceFactory<IDataGateway, IDataGatewayConfiguration>>();
    }
}